generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  password_hash String
  is_admin      Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  workflows     Workflow[]
  operationTemplates OperationTemplate[]
}

model Workflow {
  id          String      @id @default(uuid())
  name        String
  enabled     Boolean     @default(true)
  triggerPath String      @unique
  steps       Json
  created_by  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  runs        WorkflowRun[]
  createdBy   User?       @relation(fields: [created_by], references: [id], onDelete: SetNull)

  @@index([enabled])
  @@index([created_by])
}

model WorkflowRun {
  id         String   @id @default(uuid())
  workflowId String
  status     String
  startedAt  DateTime @default(now())
  finishedAt DateTime?
  error      Json?
  input      Json
  ctxFinal   Json?
  executionTrace Json?

  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, startedAt])
}

model OperationTemplate {
  id          String   @id @default(uuid())
  op          String   @unique
  visibility  String   @default("private")
  callbackType String
  attributes  Json
  created_by  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy   User     @relation(fields: [created_by], references: [id], onDelete: Cascade)

  @@index([created_by])
  @@index([visibility])
}
